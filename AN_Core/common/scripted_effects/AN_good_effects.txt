# Heavily inspired by Stockmarket mod
AN_init_REB_var = {
	set_variable = {
		which = AN_supply_$trade_good_id$
		value = 0
	}
	set_variable = {
		which = AN_demand_$trade_good_id$
		value = 0
	}
}

AN_change_REB_var = {
	change_variable = {
		which = AN_supply_$trade_good_id$
		which = PREV
	}
	change_variable = {
		which = AN_demand_$trade_good_id$
		which = PREV
	}
}

AN_init_price_update = {
	#For displaying history
	set_variable = {
		which = AN_history_demand_$trade_good_id$
		which = AN_country_total_demand_$trade_good_id$ 
	}
	set_variable = {
		which = AN_history_supply_$trade_good_id$
		which = AN_country_total_supply_$trade_good_id$ 
	}
	set_variable = {
		which = AN_history_balance_$trade_good_id$
		which = AN_history_supply_$trade_good_id$
	}
	subtract_variable = {
		which = AN_history_balance_$trade_good_id$
		which = AN_history_demand_$trade_good_id$
	}
	set_variable = {
		which = AN_history_stockpile_$trade_good_id$
		which = AN_country_stockpile_$trade_good_id$
	}
	set_variable = {
		which = AN_history_last_month_income_from_$trade_good_id$
		which = AN_last_month_income_from_$trade_good_id$
	}


	set_variable = {
		which = AN_demand_$trade_good_id$
		value = 0
	}
	set_variable = {
		which = AN_country_supply_$trade_good_id$
		value = 0
	}
}

AN_update_national_supply = {
	AN_update_national_supply_$trade_good_id$ = yes
}

AN_update_national_demand = {
	AN_update_national_demand_$trade_good_id$ = yes
}

AN_update_demand_all = {
	AN_update_demand_$trade_good_id$ = yes
}

AN_change_price_id = {
	AN_change_price_$trade_good_id$ = {
		value = $value$
		duration = $duration$
	}
}

AN_change_price = {
	change_price = {
		trade_goods = $trade_goods$
		key = "Current Market Conditions"
		value = $value$
		duration = $duration$
	}
}

AN_apply_policies = {
	if = {
		limit = {
			has_country_modifier = taxes_1_$trade_good_id$_modifier
		}
		multiply_variable = {
			which = AN_supply_$trade_good_id$
			value = 0.8
		}
	}
	else_if = {
		limit = {
			has_country_modifier = taxes_2_$trade_good_id$_modifier
		}
		multiply_variable = {
			which = AN_supply_$trade_good_id$
			value = 0.6
		}
	}
	else_if = {
		limit = {
			has_country_modifier = taxes_3_$trade_good_id$_modifier
		}
		multiply_variable = {
			which = AN_supply_$trade_good_id$
			value = 0.4
		}
	}
	else_if = {
		limit = {
			has_country_modifier = taxes_4_$trade_good_id$_modifier
		}
		multiply_variable = {
			which = AN_supply_$trade_good_id$
			value = 0.2
		}
	}
	else = { }
}

AN_post_eval = {
	#We get AN_country_supply_$trade_good_id$ from those functions
	#Here we determine how much we sell globally

	
	#For localisation
	set_variable = {
		which = AN_country_total_supply_$trade_good_id$ 
		which = AN_country_supply_$trade_good_id$
	}

	#This one is redundant but I want it to be safe and unchanged
	set_variable = {
		which = AN_country_total_demand_$trade_good_id$ 
		which = AN_demand_$trade_good_id$
	}

	#Balance for localisation, also maybe later for calculations?
	set_variable = {
		which = AN_country_total_balance_$trade_good_id$ 
		which = AN_country_total_supply_$trade_good_id$ 
	}
	subtract_variable = {
		which = AN_country_total_balance_$trade_good_id$ 
		which = AN_country_total_demand_$trade_good_id$ 
	}


	#Growth since last month
	set_variable = {
		which = AN_country_total_supply_growth_$trade_good_id$ 
		which = AN_country_total_supply_$trade_good_id$ 
	}
	subtract_variable = {
		which = AN_country_total_supply_growth_$trade_good_id$ 
		which = AN_history_supply_$trade_good_id$
	}
	set_variable = {
		which = AN_country_total_demand_growth_$trade_good_id$ 
		which = AN_country_total_demand_$trade_good_id$ 
	}
	subtract_variable = {
		which = AN_country_total_demand_growth_$trade_good_id$ 
		which = AN_history_demand_$trade_good_id$
	}
	set_variable = {
		which = AN_country_total_balance_growth_$trade_good_id$ 
		which = AN_country_total_balance_$trade_good_id$ 
	}
	subtract_variable = {
		which = AN_country_total_balance_growth_$trade_good_id$ 
		which = AN_history_balance_$trade_good_id$
	}

	set_variable = {
		which = AN_supply_$trade_good_id$ 
		which = AN_country_supply_$trade_good_id$
	}

	set_variable = {
		which = AN_max_stockpile_$trade_good_id$
		value = 500
	}
	change_variable = {
		which = AN_max_stockpile_$trade_good_id$
		which = AN_country_total_supply_$trade_good_id$ 
	}

	multiply_variable = {
		which = AN_max_stockpile_$trade_good_id$
		value = 12
	}

	# 75% goes to the global market
	multiply_variable = {
		which = AN_supply_$trade_good_id$ 
		value = 0.75
	}

	# 25% goes to the stockpile
	multiply_variable = {
		which = AN_country_supply_$trade_good_id$
		value = 0.25
	}


	if = {
		limit = {
			NOT = {
				check_variable = {
					which = AN_country_stockpile_$trade_good_id$
					which = AN_max_stockpile_$trade_good_id$
				}
			}
		}
		change_variable = {
			which = AN_country_stockpile_$trade_good_id$
			which = AN_country_supply_$trade_good_id$
		}
		if = {
			limit = {
				check_variable = {
					which = AN_country_stockpile_$trade_good_id$
					which = AN_max_stockpile_$trade_good_id$
				}
			}
			set_variable = {
				which = AN_country_stockpile_$trade_good_id$
				which = AN_max_stockpile_$trade_good_id$
			}
		}
	}
}

AN_save_old_prices = {
	set_variable = {
		which = AN_country_total_supply_growth_$trade_good_id$
		which = AN_old_supply_$trade_good_id$
	}
	subtract_variable = {
		which = AN_country_total_supply_growth_$trade_good_id$
		which = AN_supply_$trade_good_id$
	}
	multiply_variable = {
		which = AN_country_total_supply_growth_$trade_good_id$
		value = -1
	}
	set_variable = {
		which = AN_old_supply_$trade_good_id$
		which = AN_supply_$trade_good_id$
	}
	set_variable = {
		which = AN_country_total_demand_growth_$trade_good_id$
		which = AN_old_demand_$trade_good_id$
	}
	subtract_variable = {
		which = AN_country_total_demand_growth_$trade_good_id$
		which = AN_demand_$trade_good_id$
	}
	multiply_variable = {
		which = AN_country_total_demand_growth_$trade_good_id$
		value = -1
	}
	set_variable = {
		which = AN_old_demand_$trade_good_id$
		which = AN_demand_$trade_good_id$
	}
	
	set_variable = {
		which = AN_history_price_$trade_good_id$
		which = AN_price_value_$trade_good_id$
	}
}
AN_get_price_growth = {
	set_variable = {
		which = AN_prices_growth_$trade_good_id$
		which = AN_price_value_$trade_good_id$
	}
	subtract_variable = {
		which = AN_prices_growth_$trade_good_id$
		which = AN_history_price_$trade_good_id$
	}
}


AN_set_price = {
	#Assuming we have a way to get the global default price
	REB = {
		set_variable = {
			which = AN_price_value_$trade_good_id$
			value = 5
		}
		set_variable = {
			which = AN_difference_value_$trade_good_id$
			which = AN_demand_$trade_good_id$
		}
		change_variable = {
			which = AN_difference_value_$trade_good_id$
			which = AN_extra_demand_$trade_good_id$ #this is demand induced by buying goods. Slowly decays.
		}
		subtract_variable = {
			which = AN_difference_value_$trade_good_id$
			which = AN_supply_$trade_good_id$
		}
		subtract_variable = {
			which = AN_difference_value_$trade_good_id$
			which = AN_extra_supply_$trade_good_id$
		}
		set_variable = {
			which = AN_sum_value_$trade_good_id$
			which = AN_supply_$trade_good_id$
		}
		change_variable = {
			which = AN_sum_value_$trade_good_id$
			which = AN_extra_supply_$trade_good_id$
		}
		change_variable = {
			which = AN_sum_value_$trade_good_id$
			which = AN_demand_$trade_good_id$
		}
		change_variable = {
			which = AN_sum_value_$trade_good_id$
			which = AN_extra_demand_$trade_good_id$ #this is demand induced by buying goods. Slowly decays.
		}
		set_variable = {
			which = AN_price_multiplier_$trade_good_id$
			which = AN_difference_value_$trade_good_id$
		}
		divide_variable = {
			which = AN_price_multiplier_$trade_good_id$
			which = AN_sum_value_$trade_good_id$
		}
		change_variable = {
			which = AN_price_multiplier_$trade_good_id$
			value = 1
		}
		multiply_variable = {
			which = AN_price_multiplier_$trade_good_id$
			which = AN_price_multiplier_$trade_good_id$
		}

		# NEEDS to happen before removing the 1
		multiply_variable = {
			which = AN_price_value_$trade_good_id$
			which = AN_price_multiplier_$trade_good_id$
		}
		
		subtract_variable = {
			which = AN_price_multiplier_$trade_good_id$
			value = 1
		}

	}
}


	
AN_check_good_satisfaction = {
	#$trade_good_id$
	AN_clear_satisfaction_modifier = { trade_good_id = $trade_good_id$ }
	REB = {
		PREV = {
			set_variable = {
				which = AN_price_value_$trade_good_id$
				which = PREV
			}
		}
	}

 	#country_total_balance_$trade_good_id$ #Balance
	#country_supply_$trade_good_id$ #Stockpile this month
	set_variable = {
		which = temp_calc_balance
		which = AN_supply_$trade_good_id$ 
	}
	subtract_variable = {
		which = temp_calc_balance
		which = AN_demand_$trade_good_id$
	}

	#Balance without stockpile
	if = {
		limit = {
			check_variable = {
				which = temp_calc_balance
				value = 0
			}
		}

		if = {
			limit = {
				NOT = {
					is_variable_equal = {
						which = AN_demand_$trade_good_id$
						value = 0
					}
				}
			}

			set_variable = {
				which = temp_calc_percentage
				which = temp_calc_balance
			}

			divide_variable = {
				which = temp_calc_percentage
				which = AN_demand_$trade_good_id$
			}

			if = {
				limit = {
					check_variable = {
						which = temp_calc_percentage
						value = 2
					}
				}
				add_country_modifier = { 
					name = AN_over_satisfaction_$trade_good_id$
					duration = -1  
				}

			}
			else_if = {
				limit = {
					check_variable = {
						which = temp_calc_percentage
						value = 1.5
					}
				}
				add_country_modifier = { 
					name = AN_high_satisfaction_$trade_good_id$
					duration = -1  
				}
			}
		}

		set_variable = {
			which = temp_total_autosell
			which = temp_calc_balance
		}
		multiply_variable = {
			which = temp_total_autosell
			which = AN_price_value_$trade_good_id$
		}
		multiply_variable = {
			which = temp_total_autosell
			value = 0.01
		}

		AN_gain_ducats_based_on_variable = {
			variable_name = temp_total_autosell
		}

		set_variable = {
			which = AN_last_month_income_$trade_good_id$
			which = temp_total_autosell
		}

		#We can sell the rest
		#We won't send the supply globaly as it was already done
	}
	else = {
		#Check if we can use stockpile
		if = {
			limit = {
				NOT = {
					has_country_flag = AN_block_stockpile_1_$trade_good_id$
				}
			}

			#Use stockpile
			change_variable = {
				which = temp_calc_balance
				which = AN_country_stockpile_$trade_good_id$
			}	
	
		}

		#If temp is positive, that's our stockpile, if it's negative, we buy

		if = {
			limit = {
				check_variable = {
					which = temp_calc_balance
					value = 0
				}
			}

			set_variable = {
				which = AN_country_stockpile_$trade_good_id$
				which = temp_calc_balance
			}
			set_variable = {
				which = temp_calc_balance
				value = 0
			}
		}
		else = {
			#We use up stockpile and buy
			set_variable = {
				which = AN_country_stockpile_$trade_good_id$
				value = 0
			}

			multiply_variable = {
				which = temp_calc_balance
				value = -1
			}

		
			#buy trade good based on variable don't change price

			#check how much we can buy

			if = {
				limit = {
					NOT = { has_country_flag = AN_block_import_1_$trade_good_id$ }
				}

				set_variable = {
					which = temp_total_autobuy
					which = temp_calc_balance
				}

				multiply_variable = {
					which = temp_total_autobuy
					which = AN_price_value_$trade_good_id$
				}

				multiply_variable = {
					which = temp_total_autobuy
					value = 0.01
				}

				#Total cash

				export_to_variable = {
					variable_name = cash
					value = treasury
				}

				if = {
					limit = {
						has_country_flag = AN_not_unlimited_budget_$trade_good_id$
					}

					if = {
						limit = {
							check_variable = {
								which = cash
								which = AN_budget_$trade_good_id$
							}
						}
						set_variable = {
							which = cash
							which = AN_budget_$trade_good_id$
						}
					}

				}

				if = {
					limit = {
						check_variable = {
							which = cash
							which = temp_total_autobuy
						}				
					}
					#We are fine
					AN_spend_ducats_based_on_variable = {
						variable_name = temp_total_autobuy
					}
					set_variable = {
						which = AN_last_month_income_$trade_good_id$
						which = temp_total_autobuy
					}
					multiply_variable = {
						which = AN_last_month_income_$trade_good_id$
						value = -1
					}
					set_variable = {
						which = temp_calc_balance
						value = 0
					}
				}
				else = {
					subtract_variable = {
						which = temp_total_autobuy
						which = cash
					}
					AN_spend_ducats_based_on_variable = {
						variable_name = cash
					}
					set_variable = {
						which = AN_last_month_income_$trade_good_id$
						which = cash
					}
					multiply_variable = {
						which = AN_last_month_income_$trade_good_id$
						value = -1
					}

					set_variable = {
						which = temp_calc_balance
						which = temp_total_autobuy
					}
					divide_variable = {
						which = temp_calc_balance
						which = AN_price_value_$trade_good_id$
					}
					multiply_variable = {
						which = temp_calc_balance
						which = 100
					}

				}

			}
		}
		#check if any balance left
		if = {
			limit = {
				check_variable = {
					which = temp_calc_balance
					value = 0
				}
				NOT = {
					is_variable_equal = {
						which = AN_demand_$trade_good_id$
						value = 0
					}
				}
			}

			#change balance to percentage
			divide_variable = {
				which = temp_calc_balance
				which = AN_demand_$trade_good_id$
			}

			if = {
				limit = {
					check_variable = {
						which = temp_calc_balance
						value = 0.5
					}
				}
				add_country_modifier = { 
					name = severe_shortage_$trade_good_id$
					duration = -1  
				}
			}
			else_if = {
				limit = {
					check_variable = {
						which = temp_calc_balance
						value = 0.25
					}
				}
				add_country_modifier = { 
					name = AN_mediocre_shortage_$trade_good_id$
					duration = -1  
				}
			}
			else_if = {
				limit = {
					check_variable = {
						which = temp_calc_balance
						value = 0.1
					}
					total_development = 500
				}

				add_country_modifier = { 
					name = AN_acute_shortage_$trade_good_id$
					duration = -1  
				}
			}
		}
	}

	set_variable = {
		which = AN_stockpile_growth_$trade_good_id$
		which = AN_country_stockpile_$trade_good_id$
	}
	subtract_variable = {
		which = AN_stockpile_growth_$trade_good_id$
		which = AN_history_stockpile_$trade_good_id$
	}

	set_variable = {
		which = AN_country_total_income_growth_$trade_good_id$
		which = AN_last_month_income_$trade_good_id$
	}
	subtract_variable = {
		which = AN_country_total_income_growth_$trade_good_id$
		which = AN_history_last_month_income_$trade_good_id$
	}

}

AN_clear_satisfaction_modifier = {
	if = {
		limit = {
			has_country_modifier = AN_severe_shortage_$trade_good_id$
		}
		remove_country_modifier = AN_severe_shortage_$trade_good_id$
	}
	else_if = { #how will you acquire more than one, realistically?
		limit = {
			has_country_modifier = AN_mediocre_shortage_$trade_good_id$
		}
		remove_country_modifier = AN_mediocre_shortage_$trade_good_id$
	}
	else_if = {
		limit = {
			has_country_modifier = AN_acute_shortage_$trade_good_id$
		}
		remove_country_modifier = AN_acute_shortage_$trade_good_id$
	}
	else_if = {
		limit = {
			has_country_modifier = AN_high_satisfaction_$trade_good_id$
		}
		remove_country_modifier = AN_high_satisfaction_$trade_good_id$
	}
	else_if = {
		limit = {
			has_country_modifier = AN_over_satisfaction_$trade_good_id$
		}
		remove_country_modifier = AN_over_satisfaction_$trade_good_id$
	}
	else = { }
}
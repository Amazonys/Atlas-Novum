AN_buy_trade_good = {
	#We get the current price as a variable
	REB = {
		ROOT = {
			set_variable = {
				which = AN_price_value_$trade_good_id$
				which = PREV
			}

			set_variable = {
				which = AN_sum_value_$trade_good_id$
				which = PREV
			}

			set_variable = {
				which = AN_difference_value_$trade_good_id$
				which = PREV
			}
		}
	}

	change_variable = {
		which = AN_difference_value_$trade_good_id$
		value = $amount$
	}

	change_variable = {
		which = AN_sum_value_$trade_good_id$
		value = $amount$
	}

	divide_variable = {
		which = AN_difference_value_$trade_good_id$
		which = AN_sum_value_$trade_good_id$
	}

	change_variable = {
		which = AN_difference_value_$trade_good_id$
		value = 1
	}

	multiply_variable = {
		which = AN_difference_value_$trade_good_id$
		which = AN_difference_value_$trade_good_id$
	}

	multiply_variable = {
		which = AN_difference_value_$trade_good_id$
		value = 5
	}

	#Difference is now the final price!

	change_variable = {
		which = AN_price_value_$trade_good_id$
		which = AN_difference_value_$trade_good_id$
	}


	divide_variable = {
		which = AN_price_value_$trade_good_id$
		value = 2
	}

	#We have the average price here

	set_variable = {
		which = AN_final_payment
		which = AN_price_value_$trade_good_id$
	}


	multiply_variable = {
		which = AN_final_payment
		value = $amount$
	}


	AN_spend_ducats_based_on_variable = {
		variable_name = AN_final_payment
	}

	change_variable = {
		which = AN_country_stockpile_$trade_good_id$
		value = $amount$
	}

	REB = {
		change_variable = {
			which = AN_demand_$trade_good_id$
			value = $amount$
		}
		AN_set_price = {
			trade_good_id = $trade_good_id$
		}
	}
}

# Checks if has enough ducats
AN_buy_trade_good_with_given_price_amount = {
	export_to_variable = {
		which = current_treasury
		value = treasury
		who = ROOT
	}
	
	if = {
		limit = {
			check_variable = {
				which = current_treasury
				which = $variable_name_total$
			}
		}
	}

	AN_spend_ducats_based_on_variable = { variable_name = $variable_name_total$ }

	change_variable = {
		which = AN_country_stockpile_$trade_good_id$
		value = $amount$
	}

	subtract_variable = {
		which = AN_merchant_capacity_left
		value = $amount$
	}

	REB = {
		change_variable = {
			which = AN_extra_demand_$trade_good_id$
			value = $amount$
		}
		AN_set_price = { trade_good_id = $trade_good_id$ }
	}

}

# Checks if has enough stockpile
AN_sell_trade_good_with_given_price_amount = {
	if = {
		limit = {
			check_variable = {
				which = AN_country_stockpile_$trade_good_id$
				value = $amount$
			}
		}

		AN_gain_ducats_based_on_variable = { variable_name = $variable_name_total$ }

		subtract_variable = {
			which = AN_country_stockpile_$trade_good_id$
			value = $amount$
		}
	
		subtract_variable = {
			which = AN_merchant_capacity_left
			value = $amount$
		}

		REB = {
			change_variable = {
				which = AN_extra_supply_$trade_good_id$
				value = $amount$
			}
			AN_set_price = {
				trade_good_id = $trade_good_id$
			}
		}
	}
}


AN_get_average_price_buying_trade_good = {

	REB = {
		ROOT = {
			set_variable = {
				which = AN_price_value_$trade_good_id$
				which = PREV
			}

			set_variable = {
				which = AN_sum_value_$trade_good_id$
				which = PREV
			}

			set_variable = {
				which = AN_difference_value_$trade_good_id$
				which = PREV
			}
		}
	}

	change_variable = {
		which = AN_difference_value_$trade_good_id$
		value = $amount$
	}

	change_variable = {
		which = AN_sum_value_$trade_good_id$
		value = $amount$
	}

	divide_variable = {
		which = AN_difference_value_$trade_good_id$
		which = AN_sum_value_$trade_good_id$
	}

	change_variable = {
		which = AN_difference_value_$trade_good_id$
		value = 1
	}

	multiply_variable = {
		which = AN_difference_value_$trade_good_id$
		which = AN_difference_value_$trade_good_id$
	}

	multiply_variable = {
		which = AN_difference_value_$trade_good_id$
		value = 5
	}

	#Difference is now the final price!

	change_variable = {
		which = AN_price_value_$trade_good_id$
		which = AN_difference_value_$trade_good_id$
	}


	divide_variable = {
		which = AN_price_value_$trade_good_id$
		value = 2
	}

	set_variable = {
		which = AN_buying_$amount$_$trade_good_id$_price
		which = AN_price_value_$trade_good_id$
	}

	multiply_variable = {
		which = AN_buying_$amount$_$trade_good_id$_price
		value = 0.01
	}

	set_variable = {
		which = AN_buying_$amount$_$trade_good_id$_total
		which = AN_buying_$amount$_$trade_good_id$_price
	}

	multiply_variable = {
		which = AN_buying_$amount$_$trade_good_id$_total
		value = $amount$
	}
}

AN_get_average_price_selling_trade_good = {

	REB = {
		ROOT = {
			set_variable = {
				which = AN_price_value_$trade_good_id$
				which = PREV
			}

			set_variable = {
				which = AN_sum_value_$trade_good_id$
				which = PREV
			}

			set_variable = {
				which = AN_difference_value_$trade_good_id$
				which = PREV
			}
		}
	}

	subtract_variable = {
		which = AN_difference_value_$trade_good_id$
		value = $amount$
	}

	change_variable = {
		which = AN_sum_value_$trade_good_id$
		value = $amount$
	}

	divide_variable = {
		which = AN_difference_value_$trade_good_id$
		which = AN_sum_value_$trade_good_id$
	}

	change_variable = {
		which = AN_difference_value_$trade_good_id$
		value = 1
	}

	multiply_variable = {
		which = AN_difference_value_$trade_good_id$
		which = AN_difference_value_$trade_good_id$
	}

	multiply_variable = {
		which = AN_difference_value_$trade_good_id$
		value = 5
	}

	#Difference is now the final price!

	change_variable = {
		which = AN_price_value_$trade_good_id$
		which = AN_difference_value_$trade_good_id$
	}


	divide_variable = {
		which = AN_price_value_$trade_good_id$
		value = 2
	}

	set_variable = {
		which = AN_selling_$amount$_$trade_good_id$_price
		which = AN_price_value_$trade_good_id$
	}

	multiply_variable = {
		which = AN_selling_$amount$_$trade_good_id$_price
		value = 0.01
	}

	set_variable = {
		which = AN_selling_$amount$_$trade_good_id$_total
		which = AN_selling_$amount$_$trade_good_id$_price
	}

	multiply_variable = {
		which = AN_selling_$amount$_$trade_good_id$_total
		value = $amount$
	}
}


AN_spend_ducats_based_on_variable = {
	set_variable = {
		which = spending_ducats_temp
		which = $variable_name$
	}

	while = {
		limit = {
			check_variable = {
				which = spending_ducats_temp
				value = 100
			}
		}
		subtract_variable = {
			which = spending_ducats_temp
			value = 100
		}
		add_treasury = -100
	}

	while = {
		limit = {
			check_variable = {
				which = spending_ducats_temp
				value = 10
			}
		}
		subtract_variable = {
			which = spending_ducats_temp
			value = 10
		}
		add_treasury = -10
	}

	while = {
		limit = {
			check_variable = {
				which = spending_ducats_temp
				value = 1
			}
		}
		subtract_variable = {
			which = spending_ducats_temp
			value = 1
		}
		add_treasury = -1
	}

	while = {
		limit = {
			check_variable = {
				which = spending_ducats_temp
				value = 0.1
			}
		}
		subtract_variable = {
			which = spending_ducats_temp
			value = 0.1
		}
		add_treasury = -0.1
	}

	while = {
		limit = {
			check_variable = {
				which = spending_ducats_temp
				value = 0.01
			}
		}
		subtract_variable = {
			which = spending_ducats_temp
			value = 0.01
		}
		add_treasury = -0.01
	}

}

AN_gain_ducats_based_on_variable = {
	set_variable = {
		which = spending_ducats_temp
		which = $variable_name$
	}

	while = {
		limit = {
			check_variable = {
				which = spending_ducats_temp
				value = 100
			}
		}
		subtract_variable = {
			which = spending_ducats_temp
			value = 100
		}
		add_treasury = 100
	}

	while = {
		limit = {
			check_variable = {
				which = spending_ducats_temp
				value = 10
			}
		}
		subtract_variable = {
			which = spending_ducats_temp
			value = 10
		}
		add_treasury = 10
	}

	while = {
		limit = {
			check_variable = {
				which = spending_ducats_temp
				value = 1
			}
		}
		subtract_variable = {
			which = spending_ducats_temp
			value = 1
		}
		add_treasury = 1
	}

	while = {
		limit = {
			check_variable = {
				which = spending_ducats_temp
				value = 0.1
			}
		}
		subtract_variable = {
			which = spending_ducats_temp
			value = 0.1
		}
		add_treasury = 0.1
	}

	while = {
		limit = {
			check_variable = {
				which = spending_ducats_temp
				value = 0.01
			}
		}
		subtract_variable = {
			which = spending_ducats_temp
			value = 0.01
		}
		add_treasury = 0.01
	}

}


AN_prepare_immediate_values_buying = {
	clr_country_flag = AN_can_buy_1000_$trade_good_id$
	clr_country_flag = AN_can_buy_200_$trade_good_id$
	clr_country_flag = AN_can_buy_50_$trade_good_id$
	clr_country_flag = AN_can_buy_10_$trade_good_id$

	export_to_variable = {
		which = current_treasury
		value = treasury
		who = ROOT
	}

	AN_get_average_price_buying_trade_good = { amount = 10 trade_good_id = $trade_good_id$ }

	set_variable = {
		which = temp_stockpile
		which = AN_country_stockpile_$trade_good_id$
	}
	change_variable = {
		which = temp_stockpile
		value = 9.999
	}


	if = {
		limit = {
			check_variable = {
				which = current_treasury
				which = AN_buying_10_$trade_good_id$_total
			}
			check_variable = {
				which = AN_merchant_capacity_left
				value = 10
			}
			NOT = {
				check_variable = {
					which = temp_stockpile
					which = AN_max_stockpile_$trade_good_id$
				}
			}
		}

		set_country_flag = AN_can_buy_10_$trade_good_id$

		#we can buy more?
		get_average_price_buying_trade_good = { amount = 50 trade_good_id = $trade_good_id$ }
		change_variable = {
			which = temp_stockpile
			value = 40
		}
		if = {
			limit = {
				check_variable = {
					which = current_treasury
					which = AN_buying_50_$trade_good_id$_total
				}
				check_variable = {
					which = AN_merchant_capacity_left
					value = 50
				}
				NOT = {
					check_variable = {
						which = temp_stockpile
						which = AN_max_stockpile_$trade_good_id$
					}
				}
			}

			set_country_flag = AN_can_buy_50_$trade_good_id$
			AN_get_average_price_buying_trade_good = { amount = 200 trade_good_id = $trade_good_id$ }
			change_variable = {
				which = temp_stockpile
				value = 150
			}
			if = {
				limit = {
					check_variable = {
						which = current_treasury
						which = AN_buying_200_$trade_good_id$_total
					}
					check_variable = {
						which = AN_merchant_capacity_left
						value = 200
					}
					NOT = {
						check_variable = {
							which = temp_stockpile
							which = AN_max_stockpile_$trade_good_id$
						}
					}
				}
	
				set_country_flag = AN_can_buy_200_$trade_good_id$
				AN_get_average_price_buying_trade_good = { amount = 1000 trade_good_id = $trade_good_id$ }
				change_variable = {
					which = temp_stockpile
					value = 800
				}
				if = {
					limit = {
						check_variable = {
							which = current_treasury
							which = AN_buying_1000_$trade_good_id$_total
						}
						check_variable = {
							which = AN_merchant_capacity_left
							value = 1000
						}
						NOT = {
							check_variable = {
							which = temp_stockpile
							which = AN_max_stockpile_$trade_good_id$
							}
						}
					}
		
					set_country_flag = AN_can_buy_1000_$trade_good_id$
				}
			}
		}
	}
}

AN_prepare_immediate_values_selling = {
	
	if = {
		limit = {
			check_variable = {
				which = AN_country_stockpile_$trade_good_id$
				value = 0.001
			}
			check_variable = {
				which = AN_merchant_capacity_left
				value = 0.001
			}
		}

		AN_get_average_price_selling_all_trade_good = { trade_good_id = $trade_good_id$ }
		if = {
			limit = {
				check_variable = {
					which = AN_country_stockpile_$trade_good_id$
					value = 1000
				}
				check_variable = {
					which = AN_merchant_capacity_left
					value = 1000
				}
			}
			AN_get_average_price_selling_trade_good = { amount = 1000 trade_good_id = $trade_good_id$ }
			AN_get_average_price_selling_trade_good = { amount = 200 trade_good_id = $trade_good_id$ }
			AN_get_average_price_selling_trade_good = { amount = 50 trade_good_id = $trade_good_id$ }
			AN_get_average_price_selling_trade_good = { amount = 10 trade_good_id = $trade_good_id$ }
		}
		else_if = {
			limit = {
				check_variable = {
					which = AN_country_stockpile_$trade_good_id$
					value = 200
				}
				check_variable = {
					which = AN_merchant_capacity_left
					value = 200
				}
			}
			AN_get_average_price_selling_trade_good = { amount = 200 trade_good_id = $trade_good_id$ }
			AN_get_average_price_selling_trade_good = { amount = 50 trade_good_id = $trade_good_id$ }
			AN_get_average_price_selling_trade_good = { amount = 10 trade_good_id = $trade_good_id$ }
		}
		else_if = {
			limit = {
				check_variable = {
					which = AN_country_stockpile_$trade_good_id$
					value = 50
				}
				check_variable = {
					which = AN_merchant_capacity_left
					value = 50
				}
			}
			AN_get_average_price_selling_trade_good = { amount = 50 trade_good_id = $trade_good_id$ }
			AN_get_average_price_selling_trade_good = { amount = 10 trade_good_id = $trade_good_id$ }
		}
		else_if = {
			limit = {
				check_variable = {
					which = AN_country_stockpile_$trade_good_id$
					value = 10
				}
				check_variable = {
					which = AN_merchant_capacity_left
					value = 10
				}
			}
			AN_get_average_price_selling_trade_good = { amount = 10 trade_good_id = $trade_good_id$ }
		}
	}
}

AN_switch_trade_good_policy = {
	clr_country_flag = $policy$_0_$trade_good_id$
	clr_country_flag = $policy$_1_$trade_good_id$
	clr_country_flag = $policy$_2_$trade_good_id$
	clr_country_flag = $policy$_3_$trade_good_id$
	clr_country_flag = $policy$_4_$trade_good_id$
	clr_country_flag = $policy$_5_$trade_good_id$

	
	[[set_modifiers]
		if = {
			limit = {
				has_country_modifier = $policy$_1_$trade_good_id$_modifier
			}
			remove_country_modifier = $policy$_1_$trade_good_id$_modifier
		}
		else_if = {
			limit = {
				has_country_modifier = $policy$_2_$trade_good_id$_modifier
			}
			remove_country_modifier = $policy$_2_$trade_good_id$_modifier
		}
		else_if = {
			limit = {
				has_country_modifier = $policy$_3_$trade_good_id$_modifier
			}
			remove_country_modifier = $policy$_3_$trade_good_id$_modifier
		}
		else_if = {
			limit = {
				has_country_modifier = $policy$_4_$trade_good_id$_modifier
			}
			remove_country_modifier = $policy$_4_$trade_good_id$_modifier
		}
		else = { }

		add_country_modifier = { 
			name = $policy$_$level$_$trade_good_id$_modifier
			duration = -1  
		}
	]
	
	[[clean_modifiers]
		if = {
			limit = {
				has_country_modifier = $policy$_1_$trade_good_id$_modifier
			}
			remove_country_modifier = $policy$_1_$trade_good_id$_modifier
		}
		else_if = {
			limit = {
				has_country_modifier = $policy$_2_$trade_good_id$_modifier
			}
			remove_country_modifier = $policy$_2_$trade_good_id$_modifier
		}
		else_if = {
			limit = {
				has_country_modifier = $policy$_3_$trade_good_id$_modifier
			}
			remove_country_modifier = $policy$_3_$trade_good_id$_modifier
		}
		else_if = {
			limit = {
				has_country_modifier = $policy$_4_$trade_good_id$_modifier
			}
			remove_country_modifier = $policy$_4_$trade_good_id$_modifier
		}
		else = { }
	]


	set_country_flag = $policy$_$level$_$trade_good_id$
}

AN_update_merchant_capacity_modifiers_country = {
	set_variable = {
		which = AN_merchant_capacity_total
		value = 12000
	}

	#here any flags changing it


	set_variable = {
		which = AN_merchant_capacity_monthly
		value = 1000
	}

	#here any flags changing it
}

AN_update_merchant_capacity_modifiers_all = {
	every_country = {
		AN_update_merchant_capacity_modifiers_country = yes
	}
}

AN_gain_merchant_capacity_monthly_country = {
	AN_update_merchant_capacity_modifiers_country = yes
	if = {
		limit = {
			NOT = {
				check_variable = {
					which = AN_merchant_capacity_left
					which = AN_merchant_capacity_total
				}
			}
		}
		change_variable = {
			which = AN_merchant_capacity_left
			which = AN_merchant_capacity_monthly
		}

		if = {
			limit = {
				check_variable = {
					which = AN_merchant_capacity_left
					which = AN_merchant_capacity_total
				}
			}
			set_variable = {
				which = AN_merchant_capacity_left
				which = AN_merchant_capacity_total
			}
		}	
	}
}

AN_get_average_price_selling_all_trade_good = {
	REB = {
		ROOT = {
			set_variable = {
				which = AN_price_value_$trade_good_id$
				which = PREV
			}

			set_variable = {
				which = AN_sum_value_$trade_good_id$
				which = PREV
			}

			set_variable = {
				which = AN_difference_value_$trade_good_id$
				which = PREV
			}
		}
	}

	set_variable = {
		which = temp_sell_all_variable
		which = AN_country_stockpile_$trade_good_id$
	}

	if = {
		limit = {
			check_variable = {
				which = temp_sell_all_variable
				which = AN_merchant_capacity_left
			}
		}

		set_variable = {
			which = temp_sell_all_variable
			which = AN_merchant_capacity_left
		}
	}

	subtract_variable = {
		which = AN_difference_value_$trade_good_id$
		which = temp_sell_all_variable
	}

	change_variable = {
		which = AN_sum_value_$trade_good_id$
		which = temp_sell_all_variable
	}

	divide_variable = {
		which = AN_difference_value_$trade_good_id$
		which = sum_value_$trade_good_id$
	}

	change_variable = {
		which = AN_difference_value_$trade_good_id$
		value = 1
	}

	multiply_variable = {
		which = AN_difference_value_$trade_good_id$
		which = AN_difference_value_$trade_good_id$
	}

	multiply_variable = {
		which = AN_difference_value_$trade_good_id$
		value = 5
	}

	#Difference is now the final price!

	change_variable = {
		which = AN_price_value_$trade_good_id$
		which = AN_difference_value_$trade_good_id$
	}


	divide_variable = {
		which = AN_price_value_$trade_good_id$
		value = 2
	}

	set_variable = {
		which = AN_selling_all_$trade_good_id$_price
		which = AN_price_value_$trade_good_id$
	}

	multiply_variable = {
		which = AN_selling_all_$trade_good_id$_price
		value = 0.01
	}

	set_variable = {
		which = AN_selling_all_$trade_good_id$_total
		which = AN_selling_all_$trade_good_id$_price
	}

	multiply_variable = {
		which = AN_selling_all_$trade_good_id$_total
		which = temp_sell_all_variable
	}
}

AN_sell_all_trade_good_with_given_price = {
	set_variable = {
		which = temp_sell_all_variable
		which = AN_country_stockpile_$trade_good_id$
	}

	if = {
		limit = {
			check_variable = {
				which = temp_sell_all_variable
				which = AN_merchant_capacity_left
			}
		}

		set_variable = {
			which = temp_sell_all_variable
			which = AN_merchant_capacity_left
		}
	}


	if = {
		limit = {
			check_variable = {
				which = AN_country_stockpile_$trade_good_id$
				which = temp_sell_all_variable
			}
		}

		AN_gain_ducats_based_on_variable = { variable_name = $variable_name_total$ }

		subtract_variable = {
			which = AN_country_stockpile_$trade_good_id$
			which = temp_sell_all_variable
		}
	
		subtract_variable = {
			which = AN_merchant_capacity_left
			which = temp_sell_all_variable
		}

		REB = {
			change_variable = {
				which = AN_extra_supply_$trade_good_id$
				which = temp_sell_all_variable
			}
			AN_set_price = {
				trade_good_id = $trade_good_id$
			}
		}
	}
}